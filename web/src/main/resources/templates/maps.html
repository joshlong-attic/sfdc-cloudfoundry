<!DOCTYPE HTML>
<html ng-app="sfdc" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Google Force
    </title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta charset="utf-8"/>
    <link href="webjars/bootstrap/3.0.2/css/bootstrap.css" rel="stylesheet"/>
    <style>
        #console {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 1;
            width: 400px;
            padding: 10px;
            border: 2px solid lightgrey;
            background-color: white;
            overflow-y: scroll;
            bottom: 20px;
        }

        html, body {
            height: 100%;
            margin: 0px;
            padding: 0px;
        }

        #map-canvas {
            position: absolute;
            top: 0px;
            left: 0px;
            height: 100%;
            margin: 0px;
            width: 100%;
            z-index: 2;
            padding: 0px;
        }

        .results-container {
            margin-top: 30px;
            margin-left: 30px;
        }

        #status {
            margin-top: 10px;
            margin-bottom: 10px;
        }


    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&amp;sensor=false"></script>


    <script src="webjars/jquery/2.0.3/jquery.js"></script>
    <script src="webjars/bootstrap/3.0.2/js/bootstrap.js"></script>
    <script src="webjars/stomp-websocket/2.3.0/stomp.js"></script>
    <script src="webjars/sockjs-client/0.3.4/sockjs.js"></script>
    <script src="webjars/angularjs/1.2.11/angular.js"></script>
    <script src="webjars/angularjs/1.2.11/angular-resource.js"></script>


    <script language="JavaScript">
        //<![CDATA[

        ///
        /// globals
        ///
        var map;
        var appName = 'sfdc';
        var module = angular.module(appName, [ 'ngResource'  ]);

        function SfdcController($scope, $http) {

            $scope.query = 'morgan';
            $scope.results = [];

            $http.get('/user').success(function (data) {
                $scope.user = data;
            });

            var toLatLng = function (p) {
                var p = new google.maps.LatLng(p['coords']['latitude'], p['coords']['longitude']);
                return p;
            }

            navigator.geolocation.getCurrentPosition(function (position) {


                var pos = toLatLng(position); //new google.maps.LatLng({latitude: position.coords.latitude, longitude: position.coords.longitude}.latitude, {latitude: position.coords.latitude, longitude: position.coords.longitude}.longitude);


                map = new google.maps.Map(document.getElementById('map-canvas'), { mapTypeControl: false, center: pos, zoom: 13  });
                new google.maps.InfoWindow({
                    map: map,
                    position: pos,
                    content: 'You Are Here.'
                });
            });

            $('#console').css({'z-index': '100'});

            function renderResults(r) {

                $scope.results = r;

                for (var i = 0; i < $scope.results.length; i++) {
                    var result = $scope.results[i];
                    if ((result.latitude != null && result.longitude != null && result.longitude != 0.0 && result.latitude != 0.0)) {
                        new google.maps.InfoWindow({
                            map: map,
                            position: new google.maps.LatLng(result.latitude, result.longitude),
                            content: result.toString() + ''
                        });
                    }
                }
            };

            $scope.cleanName = function (r) {
                var fn = r.firstName.toLowerCase(),
                        ln = r.lastName.toLowerCase();
                fn = (fn.charAt(0) + '').toUpperCase() + fn.substring(1);
                ln = (ln.charAt(0) + '').toUpperCase() + ln.substring(1);
                return ln + ', ' + fn;
            };

            $scope.process = function () {
                $http.post('/process', $scope.query).success(function (data) {

                    $scope.batchData = data;
                    $scope.batchId = $scope.batchData.batchId;

                    $http.get('/results/' + $scope.batchId).success(function (results) {
                        renderResults(results);
                    });
                });
            };
        }


        //]]>
    </script>


</head>
<body>

<div ng-show="user != null" ng-controller="SfdcController" id="console">


    <div>Welcome <b>{{user.username}}</b>!</div>

    <br/>

    <form name="searchForm" class="navbar-form" role="search">
        <div class="input-group">
            <input type="text"
                   class="form-control"
                   placeholder="Search"
                   name="query"
                   id="query"
                   ng-model="query"/>

            <div class="input-group-btn">
                <button class="btn btn-default" ng-click="process()" type="submit"><span
                        class="glyphicon glyphicon-search"></span></button>
            </div>
        </div>
    </form>
    <div class="results-container" ng-show="results.length > 0 ">
        <div id="status" ng-show="batchData.batchId">
             <span class="results-count">
                 Displaying {{ results.length }} results.
             </span>
        </div>

        <div class="inline">
            <div ng-repeat="r in results">
                <strong> {{ cleanName(r) }} </strong> -
                <span style="font-size: smaller"><a href="#">LinkedIn</a></span>
                <!--<a href="#">view on Twitter</a> |-->
            </div>
        </div>

    </div>

</div>


<div id="map-canvas"></div>

</body>
</html>